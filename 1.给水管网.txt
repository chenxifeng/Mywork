#include<iostream>
#include<math.h>
using namespace std;
int main(){
	int m=17;   //管段数
	int n=6;    //管段环数
	double EP=0.01,T=0.014;
	int L[]={800,900,1000,600,600,600,600,800,900,1000,700,700,500,600,800,1100,600};
//	double d[]={0.35,0.25,0.2,0.4,0.2,0.1,0.1,0.35,0.3,0.1,0.2,0.2,0.2,0.15,0.2,0.2,0.2};
	double d[]={0.4,0.3,0.2,0.4,0.3,0.2,0.2,0.4,0.3,0.15,0.3,0.25,0.2,0.25,0.25,0.2,0.3};
    double q[17]={95,47,20,-100.6,28.8,12,-12.2,-60,-40,3,-30.6,25,17.7,-26.3,-28.84,-32.84,8.26};
	double q1[14]={0,9,15,28.5,45,68,96,130,168,237,355,490,685,822};
	double q2[14]={9,15,28.5,45,68,96,130,168,237,355,490,685,822,1120};
	double dd[14]={0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.6,0.7,0.8,0.9,1};
    int IO[17]={1,2,3,1,1,2,3,1,2,3,4,4,5,6,4,5,6};
    int JO[17]={0,0,0,0,2,3,0,4,5,6,0,5,6,0,0,0,0};
	double S[17],H[17],F[6],R[17],dq[6],vv[17];
	int v,u,k,kk=0,ss,i=0,j=0,mm=1;
	for(i=0;i<17;i++) {
	   S[i]=10.293*T*T*L[i]/pow(d[i],5.33);
	   q[i]=q[i]/1000;
	   }
	for(i=0;i<14;i++){
		q1[i]=q1[i]/1000;
		q2[i]=q2[i]/1000;
	}
	for(;mm!=0;){
		mm=0;

	for(;ss!=0;kk++)
	{  
		ss=0;
        for(k=0;k<m;k++)
		{
			H[k]=S[k]*q[k]*q[k];
		}
    for(i=0;i<n;i++)
	{ 
		F[i]=0;
        R[i]=0;
		for(k=0;k<m;k++)
		{
			if((fabs(IO[k])-1)==i)
			{
				F[i]+=H[k]*(q[k]/fabs(q[k]));
                R[i]+=S[k]*fabs(q[k]);
			}
            else if((fabs(JO[k])-1)==i)
			{
				F[i]+=H[k]*(-q[k]/fabs(q[k]));
                R[i]+=S[k]*fabs(q[k]);
			}     
		}
		dq[i]=(-1)*F[i]/(R[i]*2);
	}
    for(k=0;k<m;k++)
	{
		if(JO[k]==0)
		{
			u=fabs(IO[k])-1;
			q[k]+=dq[u];
		}
        else
		{ 
			u=fabs(JO[k])-1;
			v=fabs(IO[k])-1;
			q[k]+=dq[v]-dq[u];
		}
	}
    for(i=0;i<n;i++)
	{
		if(fabs(F[i])>EP)
		{
			ss=1;
		}
	}
	}
	for(j=0;j<m;j++){
		for(i=0;i<14;i++){
			if(d[j]==dd[i]){
				if(fabs(q[j])<q1[i]){
					d[j]=dd[i-1];
					mm=1;
				}
				else if(fabs(q[j])>q2[i]){
					d[j]=dd[i+1];
					mm=1;
				}
				else break;
			}
		}
		S[j]=10.293*T*T*L[j]/pow(d[j],5.33);
		H[j]=S[j]*q[j]*q[j];
	}
	}
	printf("===============================================================================\n");
	cout<<"闭合差允许值 EP="<<EP<<"        循环次数 KO="<<kk<<endl;
	cout<<"        环数 N="<<n<<"              管段数 M="<<m<<endl;
	printf("===============================================================================\n");
	printf("编号K  管长L(m)  管径D(m)  管道摩阻系数s  水头损失H(m)  流量Q(m3/s)  流速v(m/s)\n");
    printf("===============================================================================\n");
    for(k=0;k<m;k++)
	{
		vv[k]=q[k]*4/(3.14*d[k]*d[k]);
		printf("%4d    %4d      %4.0f     %10.2f      %6.2f         %7.4f     %7.3f\n",k+1,L[k],1000*d[k],S[k],H[k],q[k],vv[k]);
	}
	printf("===============================================================================\n");
	return 0;
}